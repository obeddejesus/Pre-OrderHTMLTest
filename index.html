<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Device Form</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f7fb; padding:40px; }
    .form-container { max-width:640px; margin:auto; background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h2 { margin-top:0; }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, select, button {
      width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-top:4px; box-sizing:border-box;
    }
    button { background:#00BBFF; color:#fff; font-weight:bold; border:none; cursor:pointer; margin-top:16px; }
    button:hover { background:#005299; }
    .hidden { display:none; }
    .success { color:green; margin-top:12px; }
    .error { color:red; margin-top:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Customer Device Request</h2>
    <form id="flowForm">

      <!-- Nombre y Apellido -->
      <label for="firstName">Nombre*</label>
      <input id="firstName" name="firstName" required />

      <label for="lastName">Apellido*</label>
      <input id="lastName" name="lastName" required />

      <label for="email">Correo electrónico*</label>
      <input id="email" name="email" type="email" required />

      <label for="business">Nombre del negocio*</label>
      <input id="business" name="business" required />

      <label for="contact">Número de contacto*</label>
      <input 
        id="contact" 
        name="contact" 
        type="text" 
        required 
        pattern="[0-9]+" 
        title="Solo se permiten dígitos (sin espacios ni caracteres especiales)" 
        maxlength="15"
      />

      <label for="provider">Proveedor*</label>
      <select id="provider" name="provider" required>
        <option value="">-- Seleccionar --</option>
        <option value="LibertyPR">LibertyPR</option>
        <option value="T-Mobile">T-Mobile</option>
        <option value="Claro">Claro</option>
        <option value="Other">Otro</option>
      </select>

      <!-- LibertyPR extra question -->
      <div id="libertySection" class="hidden">
        <label for="action">¿Qué deseas hacer?*</label>
        <select id="action" name="action">
          <option value="">-- Seleccionar --</option>
          <option value="New Line">Nueva línea</option>
          <option value="Change Device">Cambio de equipo</option>
        </select>
      </div>

      <!-- Device selection -->
      <label for="device">Modelo del dispositivo*</label>
      <select id="device" name="device" required>
        <option value="">-- Seleccionar --</option>
        <option value="iPhone 17">iPhone 17</option>
        <option value="iPhone 17 Air">iPhone 17 Air</option>
        <option value="iPhone 17 Pro">iPhone 17 Pro</option>
        <option value="iPhone 17 Pro Max">iPhone 17 Pro Max</option>
      </select>

      <!-- Device Color (dynamic) -->
      <div id="colorSection" class="hidden">
        <label for="color">Color del dispositivo*</label>
        <select id="color" name="color"></select>
      </div>

      <!-- Device Capacity (dynamic) -->
      <div id="capacitySection" class="hidden">
        <label for="capacity">Capacidad del dispositivo*</label>
        <select id="capacity" name="capacity"></select>
      </div>

      <!-- Consent -->
      <div style="margin-top:16px; display:flex; align-items:flex-start; gap:8px;">
        <input 
          type="checkbox" 
          id="consent" 
          name="consent" 
          required 
          style="width:18px; height:18px; margin-top:2px; cursor:pointer;"
          aria-label="Consentimiento"
        />
        <label for="consent" style="font-size:14px; color:#333; line-height:1.4; cursor:pointer;">
          ¡Permítenos conectar contigo! Al completar este formulario aceptas recibir comunicación sobre ofertas, promociones y servicios de Liberty Business.
        </label>
      </div>

      <button type="submit">Enviar</button>
      <div id="msg"></div>
    </form>
  </div>

  <script>
    const FLOW_URL = "https://prod-68.westus.logic.azure.com:443/workflows/477d1e2a09fb4d5eba05a9c4c8800a98/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EzBolja5p4JJdK2xwH-0Szv77OXsKj3qYjn1HsfAcbU"; 

    const providerSelect = document.getElementById('provider');
    const libertySection = document.getElementById('libertySection');
    const deviceSelect   = document.getElementById('device');
    const colorSection   = document.getElementById('colorSection');
    const colorSelect    = document.getElementById('color');
    const capacitySection= document.getElementById('capacitySection');
    const capacitySelect = document.getElementById('capacity');
    const contactField   = document.getElementById('contact');

    // Opciones de dispositivos
    const deviceOptions = {
      "iPhone 17": { colors: ["Brown", "Yellow"], capacities: ["128GB", "256GB"] },
      "iPhone 17 Air": { colors: ["Clear", "Blue"], capacities: ["128GB", "256GB"] },
      "iPhone 17 Pro": { colors: ["Gold", "Titan"], capacities: ["256GB", "512GB"] },
      "iPhone 17 Pro Max": { colors: ["Titanium", "Natural"], capacities: ["256GB", "512GB", "1TB"] }
    };

    // Mostrar/ocultar sección Liberty
    providerSelect.addEventListener('change', () => {
      libertySection.classList.toggle('hidden', providerSelect.value !== "LibertyPR");
    });

    // Actualizar colores/capacidades al cambiar dispositivo
    deviceSelect.addEventListener('change', () => {
      const device = deviceSelect.value;
      if (deviceOptions[device]) {
        colorSelect.innerHTML = "<option value=''>-- Seleccionar --</option>" +
          deviceOptions[device].colors.map(c => `<option value="${c}">${c}</option>`).join("");
        colorSection.classList.remove('hidden');
        colorSelect.required = true;

        capacitySelect.innerHTML = "<option value=''>-- Seleccionar --</option>" +
          deviceOptions[device].capacities.map(c => `<option value="${c}">${c}</option>`).join("");
        capacitySection.classList.remove('hidden');
        capacitySelect.required = true;
      } else {
        colorSection.classList.add('hidden');
        capacitySection.classList.add('hidden');
        colorSelect.required = false;
        capacitySelect.required = false;
      }
    });

    const form = document.getElementById('flowForm');
    const msg  = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = "Enviando…";
      msg.className = "";

      // Validación adicional de número de contacto
      if (!/^[0-9]+$/.test(contactField.value)) {
        msg.className = "error";
        msg.textContent = "❌ El número de contacto solo debe contener dígitos (sin espacios, letras ni caracteres especiales)";
        return;
      }

      // Payload
      const payload = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        business: document.getElementById('business').value.trim(),
        contact: contactField.value.trim(),
        provider: providerSelect.value,
        device: deviceSelect.value,
        color: colorSelect.value,
        capacity: capacitySelect.value,
        consent: document.getElementById('consent').checked,
        submittedAt: new Date().toISOString()
      };

      if (providerSelect.value === "LibertyPR") {
        payload.action = document.getElementById('action').value;
      }

      try {
        const res = await fetch(FLOW_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (res.ok) {
          msg.className = "success";
          msg.textContent = "Formulario enviado correctamente ✅";
          form.reset();
          libertySection.classList.add('hidden');
          colorSection.classList.add('hidden');
          capacitySection.classList.add('hidden');
        } else {
          msg.className = "error";
          msg.textContent = "Error: " + text;
        }
      } catch (err) {
        msg.className = "error";
        msg.textContent = "Fallo al enviar: " + err.message;
      }
    });

    // Mensajes personalizados en español
    const validations = [
      { id: "firstName", msg: "Por favor ingresa tu nombre" },
      { id: "lastName", msg: "Por favor ingresa tu apellido" },
      { id: "email", msg: "Por favor ingresa un correo válido" },
      { id: "business", msg: "Por favor ingresa el nombre del negocio" },
      { id: "contact", msg: "Por favor ingresa un número de contacto" },
      { id: "provider", msg: "Por favor selecciona un proveedor" },
      { id: "action", msg: "Por favor selecciona una acción" },
      { id: "device", msg: "Por favor selecciona un modelo de dispositivo" },
      { id: "color", msg: "Por favor selecciona un color" },
      { id: "capacity", msg: "Por favor selecciona una capacidad" },
      { id: "consent", msg: "Debes aceptar el consentimiento para continuar" }
    ];

    validations.forEach(v => {
      const el = document.getElementById(v.id);
      if (el) {
        el.oninvalid = function(e) {
          e.target.setCustomValidity(v.msg);
        };
        el.oninput = function(e) {
          e.target.setCustomValidity("");
        };
      }
    });
  </script>
</body>
</html>
